#!/usr/bin/env bash
##################################
# åç§°ï¼škubernetes kubectl æ‰©å±•åŠŸèƒ½
# ä½œè€…ï¼šç™¾é‡Œ
# github: github.com/yezihack/k1s
# åˆ›å»ºæ—¶é—´ï¼š2022/11/24
# æœ€åä¿®æ”¹æ—¶é—´ï¼š2024/07.08
#################################
version=2.2.2
############å‚æ•°###########
# èµ„æºåç§°
resource=$1

# å‚æ•°1,æ¥å—åº”ç”¨åç§°
param01=$2

# åŠ¨ä½œç±»å‹
action=$3

# æ‰©å±•å‚æ•°
param02=$4

# æ‰©å±•å‚æ•°
param03=$5

# æ‰©å±•å‚æ•°
param04=$6

# å‘½åç©ºé—´
nameSpace=${K1S_NS:="default"}
[ -n "${K1N}" ] && nameSpace="${K1N}"

#####################################
# é•œåƒåç§°
base_image=${K1S_IMAGE:="alpine:latest"}
[ -n "${K1I}" ] && base_image="${K1I}"

# å­˜å‚¨yamlè·¯å¾„
savePath=${K1S_PATH:=$PWD}
# åˆ¤æ–­æ˜¯å¦ä»¥ / ç»“å°¾ï¼Œè‡ªåŠ¨è¡¥å…¨
[[ ${savePath: -1} != "/" ]] && savePath="${savePath}/"
[ -n "${K1P}" ] && savePath="${K1P}"

# kubectl 
k=kubectl
###########################
# é”™è¯¯åˆ—è¡¨ï¼Œç”¨äºåˆ é™¤
err_list=(
	"UnexpectedAdmissionError"
	"Terminating"
	"OutOfcpu"
	"Evicted"
)

# action åˆ—è¡¨
action_list=(
	"ls"
	"list"
	"desc"
	"describe"
	"y"
	"yml"
	"yaml"
	"wide"
	"w"
	"e"
	"exec"
	"auto"
	"delete"
	"del"
	"rm"
	"log"
	"logs"
	"tail"
	"tailf"
	"like"
)

############å†…ç½®å‡½æ•°#############

# åˆ¤æ–­ç»“æœçŠ¶æ€
alert() {
	local val=$1
	local ret=$?
	if [[ ${ret} -eq 0 ]]; then
		yello "${val} æˆåŠŸ"
	else
		red "${val} å¤±è´¥"
	fi
}
# æç¤º
green() {
	local val=$1
	echo -e "\033[32m ${val} \033[0m"
}
# ç¦æ­¢
red() {
	local val=$1
	echo -e "\033[31m ${val} \033[0m"
}
# è­¦å‘Š
yello() {
	local val=$1
	echo -e "\033[33m ${val} \033[0m"
}

blue() {
	local val=$1
	echo -e "\033[34m ${val} \033[0m"
}
# é’ç»¿è‰²
cyan() {
	local val=$1
	echo -e "\033[36m ${val} \033[0m"
}
# retrun 1 is exist. return 0 no exist.
in_array () {     
	arr=$1; # æ•°ç»„
	param=$2; # è¢«åˆ¤æ–­çš„å¯¹è±¡
	shift
	echo "${arr[@]}"
    for elem in "${arr[@]}";
    do		
        [[ "$param" = "$elem" ]] && return 1;		
    done;
    return 0
}

help() {
	scriptName=$0
	scriptName=$(basename "${scriptName}")
	local tools=(		
		"--------------- â†“ âš™ æ“ä½œå…¬å¼ â†“ ---------------"		
		"${scriptName} [resources] [èµ„æºåç§°] [action] [extend]"
		"--------------- â†“ â˜† ç‰¹æ®Šèµ„æº â†“ ---------------"
		"éƒ¨ç½²/é‡è£…:         ${scriptName} apply/a {èµ„æºåç§°}"
		"è¿›å…¥å®¹å™¨:          ${scriptName} exec/auto,e {èµ„æºåç§°}"
		"è¿›å…¥NODE:          ${scriptName} x/nsenter {èŠ‚ç‚¹åç§°}"
		"æ¸…ç†:              ${scriptName} clean {èµ„æºåç§°}"
		"---------- â†“ â˜¯ èµ„æºåˆ—è¡¨(resources)  â†“ ----------"
		"ç»„ä»¶å¥åº·: 		componentstatuses / cs"
		"é…ç½®ç®¡ç†èµ„æº: 	configmaps / cm"
		"ç«¯ç‚¹:		endpoints / ep"
		"äº‹ä»¶: 		events / ev"
		"èµ„æºç®¡ç†é™åˆ¶: 	limitranges / limits"
		"å‘½åç©ºé—´: 		namespaces / ns"
		"èŠ‚ç‚¹èµ„æº: 		nodes / node / no"
		"å£°æ˜æŒä¹…å·: 	persistentvolumeclaims / pvc "
		"æŒä¹…å·: 		persistentvolumes / pv "
		"Pod èµ„æº: 		pods / po / ps "
		"å‰¯æœ¬æ§åˆ¶å™¨: 	replicationcontrollers / rc "
		"ç¡¬æ€§èµ„æºé™é¢: 	resourcequotas / quota "
		"å¯†é’¥å­˜å‚¨: 		secrets / secret / sec "
		"Service èµ„æº: 	nodes / node "
		"å®ˆæŠ¤è¿›ç¨‹èµ„æº: 	daemonsets / ds "
		"æ— çŠ¶æ€æ§åˆ¶å™¨: 	deployments / deploy / d "
		"å‰¯æœ¬é›†åˆèµ„æº: 	replicasets / rs "
		"æœ‰çŠ¶æ€æ§åˆ¶å™¨: 	statefulsets / sts "
		"æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å™¨: 	horizontalpodautoscalers / hpa "
		"å®šæ—¶ä»»åŠ¡å™¨: 	cronjobs / cj "
		"ä¸€æ¬¡æ€§ä»»åŠ¡å™¨: 	jobs / job "
		"Ingressesèµ„æº: 	ingresses / ing "
		"Ingress åˆ†ç±»å™¨: 	ingressclasses / ingc "
		"RBAC é›†ç¾¤è§’è‰²ç»‘å®š:	clusterrolebindings / crb "
		"RBAC æœåŠ¡å¸å·: 	serviceaccounts / sa "
		"RBAC é›†ç¾¤è§’è‰²: 	clusterroles / cr "
		"RBAC è§’è‰²ç»‘å®š: 	rolebindings / rb "
		"RBAC è§’è‰²: 	roles / ro "
		"StorageClass èµ„æº: StorageClass/sc "
		"---------- â†“ â˜¯ èµ„æºåˆ—è¡¨(CRD)  â†“ ----------"
		"ServiceMonitor: 	servicemonitor / sm "
		"--------------- â†“ ğŸ›  åŠ¨ä½œ(Action) â†“ ---------------"
		"æ˜¾ç¤ºåˆ—è¡¨: 		list / ls"
		"æŸ¥çœ‹è¯¦æƒ…: 		describe / desc"
		"æŸ¥çœ‹ YAML: 	yaml / yml / y"
		"æŸ¥çœ‹æ›´å¤šä¿¡æ¯: 	wide / w"
		"è¿›å…¥å®¹å™¨æ“ä½œ: 	exec / auto / e"
		"åˆ é™¤èµ„æºæ“ä½œ: 	delete / del / rm"
		"æ—¥å¿—æ“ä½œ: 		logs / log"
		"æœ€è¿‘æ—¥å¿—: 		tail"
		"ç›‘å¬æ—¥å¿—: 		tailf"
		"æ¨¡ç³ŠæŸ¥æ‰¾: 		like"		
		"ç¼–è¾‘ YAML: 	edit"		
		"--------------- â†“ â˜€ å®ä¾‹(Example) â†“ ---------------"
		"æŸ¥çœ‹ pod åˆ—è¡¨: 			${scriptName} po"
		"æŸ¥çœ‹ pod è¯¦æƒ…: 			${scriptName} po kube-pod-xxx desc"
		"æŸ¥çœ‹ pod æ—¥å¿—: 			${scriptName} po kube-pod-xxx log"
		"æŸ¥çœ‹ pod æ—¥å¿—(å…ˆå‰æ—¥å¿—): 		${scriptName} po kube-pod-xxx log p"
		"æŸ¥çœ‹ pod æ—¥å¿—(c): 			${scriptName} po kube-pod-xxx log client (client è¡¨ç¤ºå®¹å™¨åç§°)"
		"æŸ¥çœ‹ pod æ—¥å¿—(c,å…ˆå‰æ—¥å¿—):		${scriptName} po kube-pod-xxx log p client (client è¡¨ç¤ºå®¹å™¨åç§°)"
		"æŸ¥çœ‹ pod æœ€è¿‘æ—¥å¿—: 		${scriptName} po kube-pod-xxx log 10"		
		"ç›‘å¬ pod æ—¥å¿—: 			${scriptName} po kube-pod-xxx tailf"
		"è¿›å…¥ pod å®¹å™¨: 			${scriptName} po kube-pod-xxx exec"
		"è¿›å…¥ pod å®¹å™¨(c): 			${scriptName} po kube-pod-xxx exec client (client è¡¨ç¤ºå®¹å™¨åç§°)"
		"ç¼–è¾‘ YAML:				${scriptName} po kube-pod-xxx edit"
		"åˆ é™¤ pod:				${scriptName} po kube-pod-xxx del"
		"å¼ºåˆ¶åˆ é™¤ pod:			${scriptName} po kube-pod-xxx rm"
		"è°ƒè¯• node:				${scriptName} x kube-node-xxx"
		"--------------- â†“ â¤ å¸®åŠ©(Help) â†“ ---------------"
		"æŸ¥çœ‹å¸®åŠ©ï¼š         ${scriptName} help|h"
	)
	local set_env=(
		"1. è®¾ç½®YAMLè·¯å¾„çš„ç¯å¢ƒå˜é‡æ–¹å¼: export K1S_PATH=/home/ æˆ– export K1P=/home/, é»˜è®¤ä¸º å½“å‰ç›®å½•"
		"2. è®¾ç½®å‘½åç©ºé—´çš„ç¯å¢ƒå˜é‡æ–¹å¼: export K1S_NS=default æˆ– export K1N=default, é»˜è®¤ä¸º default"
		"3. è®¾ç½®åŸºç¡€é•œåƒ: export K1S_IMAGE=alpine:latest æˆ– export K1I=alpine:latest,é»˜è®¤ä¸º alpine:latest"
	)
	local envs=(
		"1. å½“å‰æ“ä½œçš„è·¯å¾„ï¼š${savePath}"
		"2. å½“å‰æ“ä½œçš„ç©ºé—´åï¼š${nameSpace}"
		"3. å½“å‰åŸºç¡€é•œåƒï¼š${base_image}"
	)
	cat <<EOF
   _   _   _  
  / \ / \ / \ 
 ( k | 1 | s )
  \_/ \_/ \_/ 
  	by ç™¾é‡Œ(github.com/yezihack/k1s)
   so easy, so fast.
 version: ${version}
EOF
	local i=0
	for name in "${tools[@]}"; do
		((i++)) # è‡ªå¢
		if [[ ${i} -le 9 ]]; then
			inc="0${i}"
		else
			inc=${i}
		fi
		line_count=$(echo "${name}" | grep -c "â†“")
		if [ "${line_count}" -gt 0 ]; then
			i=0
			yello "${name}"
		else
			cyan "${inc}. ${name}"
		fi

	done	
	echo "SET ENVIRONMENT:"
	for name in "${set_env[@]}"; do
		green "${name}"
	done
	echo "CURRENT:"
	for name in "${envs[@]}"; do
		yello "${name}"
	done
}

tip() {
	local envs=(
		"1. å½“å‰æ“ä½œçš„è·¯å¾„ï¼š${savePath}"
		"2. å½“å‰æ“ä½œçš„ç©ºé—´åï¼š${nameSpace}"
	)
	for name in "${set_env[@]}"; do
		green "${name}"
	done
}
# ä¸æ”¯æŒæç¤º
nosupport() {
	op=$1
	red "å½“å‰èµ„æºä¸æ”¯æŒã€${op}ã€‘æ“ä½œ"
}
# æ˜¯å¦ç»§ç»­å‡½æ•°
IsContinue() {
	local msg=$1
	while true; do
		read -r -p "${msg}" ok
		case "${ok}" in
		[Yy])
			break
			;;
		[Nn])
			echo "å®‰å…¨é€€å‡º"
			exit 0
			;;
		esac
	done
}

# ç”¨äºYESè¿˜æ˜¯NOï¼ŒYESè¿”å›0ï¼ŒNOè¿”å›1
IsYesNo() {
	local msg=$1
	while true; do
		read -r -p "${msg}" ok
		case "${ok}" in
		[Yy])
			return 0
			;;
		[Nn])
			return 1
			;;
		esac
	done
}

# ä¸´æ—¶åˆ›å»º nsenter å®¹å™¨
execTemporaryPod() {
    node=$1
    if [ -z "${node}" ];then 
        red "Please input your node name."
        exit 0
    fi
    exist=$($k get node|grep -wc "${node}")
    if [ "${exist}" -eq 0 ];then
        red "The node does not exist"
        exit 0
    fi
    cmd='[ "nsenter", "--target", "1", "--mount", "--uts", "--ipc", "--net", "--pid", "--", "bash"]'
    overrides="$(
        cat <<EOT
{
  "spec": {
    "enableServiceLinks": false,
    "nodeName": "$node",
    "hostPID": true,
    "hostNetwork": true,
    "containers": [
      {
        "securityContext": {
          "privileged": true
        },
        "image": "${base_image}",
        "name": "nsenter",
        "stdin": true,
        "stdinOnce": true,
        "tty": true,
        "command": $cmd
      }
    ],
    "tolerations": [
      {
        "operator": "Exists"
      }
    ]
  }
}
EOT
    )"
    # pod="kube-nodeshell-$(env LC_ALL=C tr -dc a-z0-9 </dev/urandom | head -c 6)"
    pod="kube-nodeshell-$(uuidgen)"
    yello "Pod: ${pod}"
    green "Connecting $node ..."
    $k run --image="${base_image}" --restart=Never --rm --overrides="$overrides" -it "${pod}"
	if [ $? -ne 0 ];then 
		# åˆ¤æ–­ pod æ˜¯å¦å­˜åœ¨
		if $k get pod "${pod}" >/dev/null 2>&1; then			
			red "###################### ERROR INFOMATION #######################"
			# åˆ†æé”™è¯¯
			events_msg=$($k describe pod "${pod}" |awk '/Events:/,0')
			echo "${events_msg}"
			error_msg=$(echo "$events_msg" | grep -iE 'rpc error|i/o timeout')
			if [ -n "$error_msg" ]; then
				yello "å¦‚æœå‡ºç° pull image <${base_image}>: rpc error,è¯´æ˜ node:${node} æ²¡æœ‰å¤–ç½‘å¯¼è‡´çš„"
				green "++++++++++++++ TIP +++++++++++++++"
				cyan "å¯ä»¥è®¾ç½®å†…ç½‘é•œåƒ: export K1S_IMAGE=hub.local.io/alpine:latest"
			fi
			# æœ€ååˆ é™¤ pod
			$k delete pod "${pod}"
		fi
    fi
}

# åˆ¤æ–­å½“å‰ kubectl æ˜¯å¦å°äº1.18ç‰ˆæœ¬ã€‚è¿”å› 1åˆ™å¤§äºç­‰äº1.18ï¼Œ0åˆ™å°äº1.18
IsGtK8sVersion118() {
	version=$($k version | sed -r "s/.*(v[0-9]+\.[0-9]+\.[0-9]+).*/\1/g" | sed -n '1p')
	versionNumber=$(echo "${version}" | sed -r "s/[v\.]//g")
	versionNumber=${versionNumber:0:4}
	if [ "${versionNumber}" -ge 1180 ]; then
		return 1
	fi
	return 0
}

# åˆ¤æ–­æ˜¯å¦æ”¯æŒ action
check_action() {
	in_action=$1	
	exist=0
	for elem in "${action_list[@]}";do
		[[ ${elem} = "${in_action}" ]] && exist=1
	done
	if [ ${exist} -eq 0 ];then
		red "Thisã€${in_action}ã€‘action is not supported"
		# ä»…æ”¯æŒä»¥ä¸‹ action æ“ä½œã€‚
		cyan "Support list: ${action_list[*]}"
	fi
}

# è¿›å…¥å®¹å™¨å†…éƒ¨æ“ä½œ
autoExecPod() {
	param01=$1 # pods åç§°
	containerName=$2 # å®¹å™¨åç§°
	cyan "++++++++++++++++ è¿›å…¥ ${param01} pod å®¹å™¨ ++++++++++++++++"
	# ä»åç§°ä¸­è‡ªåŠ¨è·å– pod åç§°
	podsName=$($k get pods -n "${nameSpace}" | grep "${param01}" | sed -n '1p' | awk '{print $1}')
	if [ -z "${podsName}" ]; then
		red "è·å– POD åç§°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æˆ–ä½¿ç”¨ exec-pod æ–¹å¼ã€‚"
		exit 1
	fi
	# åç§°ä¸ç›¸ç­‰ï¼Œåˆ™æç¤ºè‡ªåŠ¨è·å–çš„åç§°ã€‚
	if [ "${podsName}" != "${param01}" ];then
		green "è‡ªåŠ¨è·å–ç¬¬ä¸€ä¸ªPODåç§°: ${podsName}"
	fi
	if [ -n "${containerName}" ];then 
		green "è¿›å…¥ ContainerName: ${containerName}"
		$k -n "${nameSpace}" exec -it -c "${containerName}" "${podsName}" /bin/bash
		# å¦‚æœå‡ºé”™çš„è¯ï¼Œå°è¯•å¦ä¸€ç§æ–¹å¼
		if [ $? -ne 0 ]; then
			green "bash æ–¹å¼å¤±è´¥ï¼Œæ­£åœ¨å°è¯• sh æ–¹å¼è¿›å…¥å®¹å™¨ï¼š"
			$k -n "${nameSpace}" exec -it -c "${containerName}" "${podsName}" sh
		fi
	else
		green "è¿›å…¥ ContainerName: é»˜è®¤ç¬¬ä¸€ä¸ªå®¹å™¨"
		$k -n "${nameSpace}" exec -it  "${podsName}" /bin/bash
		# å¦‚æœå‡ºé”™çš„è¯ï¼Œå°è¯•å¦ä¸€ç§æ–¹å¼
		if [ $? -ne 0 ]; then
			green "bash æ–¹å¼å¤±è´¥ï¼Œæ­£åœ¨å°è¯• sh æ–¹å¼è¿›å…¥å®¹å™¨ï¼š"
			$k -n "${nameSpace}" exec -it "${podsName}" sh
		fi
	fi	
}


#########################
check_apply() {
	# 0. æ£€æŸ¥	
	## æ£€æŸ¥è®¾ç½®è·¯å¾„
	if [ -z "${savePath}" ]; then
		red "è¯·è®¾ç½®çš„YAMLè·¯å¾„çš„ç¯å¢ƒå˜é‡ï¼"
		exit 1
	fi

	## è·¯å¾„æ˜¯å¦æœ‰æ•ˆ
	if [ ! -d "${savePath}" ]; then
		red "${savePath} è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥"
		exit 1
	fi

	green "å½“å‰è®¾ç½®çš„YAMLè·¯å¾„: ${savePath}"

	## æ£€æŸ¥è¾“å…¥å‚æ•°
	if [ -z "${param01}" ]; then
		red "è¯·è¾“å…¥æ‚¨çš„åº”ç”¨åç§°ï¼"
		exit 1
	fi

	## æ£€æŸ¥åº”ç”¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
	### åˆ¤æ–­æ˜¯å¦å­˜åœ¨åç¼€ï¼Œå¦‚æœå­˜åœ¨åç¼€ï¼Œå°±ä¸æ·»åŠ åç¼€
	gapCount=$(echo "${param01}" | grep -c "\.")
	if [ "${gapCount}" -gt 0 ]; then
		fullFile="${savePath}${param01}"
		param01=$(echo "${param01}" | cut -d . -f1)
	else
		# é»˜è®¤æ·»åŠ  .yaml åç¼€
		fullFile="${savePath}${param01}.yaml"
	fi

	if [ ! -f "${fullFile}" ]; then
		red "${fullFile} æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥"
		exit 1
	fi
}
# æ–°éƒ¨ç½²
apply() {
	tip
	check_apply
	$k get -f "${fullFile}" &>/dev/null
	if [ $? -eq 1 ]; then
		cyan "+++++++++++++++++ æ–°éƒ¨ç½² +++++++++++++++++"
		IsContinue "æ˜¯å¦å‡†å¤‡å¥½æ–°åº”ç”¨éƒ¨ç½²ï¼šã€${param01}ã€‘(Y/N):"
	else
		cyan "+++++++++++++++++ é‡æ–°éƒ¨ç½² +++++++++++++++++"
		$k diff -f "${fullFile}"
		IsContinue "è§‚å¯Ÿå½“å‰ YAML çš„å·®å¼‚, æ˜¯å¦å‡†å¤‡å¥½é‡æ–°éƒ¨ç½²åº”ç”¨ï¼šã€${param01}ã€‘(Y/N):"
	fi

	# æ¨¡æ‹Ÿè¿è¡Œæ˜¯å¦å¯è¡Œ
	IsGtK8sVersion118
	ret=$?
	if [ $ret -eq 1 ]; then
		$k apply -f "${fullFile}" --dry-run=client
		alert "client ç«¯:æ¨¡æ‹Ÿè¿è¡Œ"
		$k apply -f "${fullFile}" --dry-run=server
		alert "server ç«¯:æ¨¡æ‹Ÿè¿è¡Œ"
	else
		$k apply -f "${fullFile}" --dry-run
		alert "client ç«¯ï¼Œæ¨¡æ‹Ÿè¿è¡Œ"
		$k apply -f "${fullFile}" --server-dry-run
		alert "server ç«¯ï¼Œæ¨¡æ‹Ÿè¿è¡Œ"
	fi

	# çœŸå®è¿è¡Œ
	IsContinue "æ‚¨æ­£åœ¨å‡†å¤‡è¿è¡Œéƒ¨ç½²åº”ç”¨åä¸º:ã€${param01}ã€‘,æ˜¯å¦ç¡®è®¤(Y/N):"
	$k apply -f "${fullFile}"

	# 5. è§‚å¯Ÿåº”ç”¨çŠ¶æ€
	$k get -f "${fullFile}"

	# 6. æŸ¥çœ‹åº”ç”¨è¯¦æƒ…
	IsContinue "æ˜¯å¦æŸ¥çœ‹åº”ç”¨:ã€${param01}ã€‘ çš„éƒ¨ç½²è¯¦æƒ…(Y/N):"
	$k describe -f "${fullFile}"
}

# èµ„æºæ“ä½œå¤§é›†åˆ
k1s_resource_action() {
	# èµ„æºåç§°
	resouce_name=$1
	# å‚æ•°01ï¼Œå³å…·ä½“åç§°ï¼Œå¦‚ pod åç§°,è¿˜å…¼å®¹ wide
	param_name=$2
	# åŠ¨ä½œåç§°ï¼Œé»˜è®¤ä¸º list	
	action_name=$3
	action_name=${action_name:="list"}
	# æ‰©å±•å‚æ•°
	param05=$4
	# æ‰©å±•å‚æ•°
	param06=$5
	# æ‰©å±•å‚æ•°
	param07=$6	
	# è¾“å‡ºåŸºç¡€ä¿¡æ¯
	yello "######## namespace:${nameSpace} # resouce-name:${resouce_name} # action:${action_name} # param_name:${param_name} ########"
	# æ£€æŸ¥ Action æ˜¯å¦æœ‰æ•ˆ
	check_action "${action_name}"

	# åˆ†æ”¯åˆ¤æ–­
	case "X${action_name}" in
	"Xlist" | "Xwide" | "Xw") # è·å–èµ„æºåˆ—è¡¨
		if [ -z "${param_name}" ];then
			$k -n ${nameSpace} get "${resouce_name}"
		elif [ "${param_name}" = "wide" ] || [ "${param_name}" = "w" ]; then 
			$k -n ${nameSpace} get "${resouce_name}" -o wide
		elif [ "${action_name}" = "wide" ] || [ "${action_name}" = "w" ]; then
			$k -n ${nameSpace} get "${resouce_name}" "${param_name}" -o wide
		else 
			$k -n ${nameSpace} get "${resouce_name}" "${param_name}"
		fi
	;;
	"Xlike") # æ¨¡ç³ŠæŸ¥æ‰¾
		$k -n ${nameSpace} get "${resouce_name}" |grep -i "${param_name}"
	;;
	"Xdescribe" | "Xdesc") # æŸ¥çœ‹èµ„æºè¯¦æƒ…
		$k -n ${nameSpace} describe "${resouce_name}" "${param_name}"
	;;
	"Xyaml" | "Xyml" | "Xy") # æŸ¥çœ‹èµ„æºYAML
		$k -n ${nameSpace} get "${resouce_name}" "${param_name}" -o yaml
	;;
	"Xexec"| "Xe" | "Xauto") # è¿›å…¥å®¹å™¨ï¼Œåªé™ pods
		if [ "${resouce_name}" = "pods" ];then
			autoExecPod "${param_name}" "${param05}"
		else
			nosupport "${action_name}"
			exit 0
		fi
	;;
	"Xdelete" | "Xdel")
		no_support_resource=("nodes" "clean")
		if echo "${no_support_resource[@]}" | grep -qw "${resouce_name}"; then
			nosupport "${action_name}"
			exit 0
		fi
		IsContinue "å½“å‰æ˜¯ã€deleteã€‘è¯·è°¨æ…æ“ä½œ,æ˜¯å¦åˆ é™¤èµ„æºã€${param_name}ã€‘(Y/N):"
		$k -n ${nameSpace} delete "${resouce_name}" "${param_name}"
		if [ $? -eq 0 ]; then 
			green "èµ„æºã€${param_name}ã€‘ åˆ é™¤æˆåŠŸ"
		else 
			red "èµ„æºã€${param_name}ã€‘ åˆ é™¤å¤±è´¥"
		fi
	;;
	"Xrm") # å¼ºåˆ¶åˆ é™¤
		no_support_resource=("nodes" "clean")
		if echo "${no_support_resource[@]}" | grep -qw "${resouce_name}"; then
			nosupport "${action_name}"
			exit 0
		fi
		IsContinue "å½“å‰æ˜¯ã€ å¼ºåˆ¶åˆ é™¤ rm ã€‘è¯·è°¨æ…æ“ä½œ,æ˜¯å¦å¼ºåˆ¶åˆ é™¤èµ„æºã€${param_name}ã€‘(Y/N):"
		$k -n ${nameSpace} delete "${resouce_name}" "${param_name}" --grace-period=0 --force
		if [ $? -eq 0 ]; then 
			green "èµ„æºã€${param_name}ã€‘ åˆ é™¤æˆåŠŸ"
		else 
			red "èµ„æºã€${param_name}ã€‘ åˆ é™¤å¤±è´¥"
		fi
	;;
	"Xlogs"|"Xlog") # è¾“å‡ºå…¨éƒ¨æ—¥å¿—
		# previous
		previous=${param05}		
		containerName=${param06}		
		if [ -n "$(echo "${previous}"| sed -n "/^[0-9]\+$/p")" ];then # è¡¨ç¤ºæ•°å­—
			showNumber=${previous}
			$k -n ${nameSpace} logs --tail="${showNumber}" "${param_name}"
			[[ $? -ne 0 ]] && exit 0
			cyan "++++++++++++++++++++++++++ æ˜¾ç¤ºæœ€è¿‘ ${showNumber} æ¡æ•°æ® ++++++++++++++++++++++++++ "
		elif [ "${previous}" = "p" ];then
			cyan "æ­£åœ¨æŸ¥çœ‹å…ˆå‰æ—¥å¿—:"
			# å¦‚æœ param06 æ˜¯æ•°å­—åˆ™å°† containerName è®¾ç½®ä¸ºç©º
			if [ -n "$(echo "${param06}"| sed -n "/^[0-9]\+$/p")" ];then # è¡¨ç¤ºæ•°å­—
				containerName=""
			fi
			# å¦‚æœæ²¡æœ‰ container åˆ™ param06 åˆ¤æ–­æ˜¯å¦æ•°å­—
			if [ -z "${containerName}" ];then 
				showNumber=${param06}
				if [ -n "$(echo "${showNumber}"| sed -n "/^[0-9]\+$/p")" ];then # è¡¨ç¤ºæ•°å­—
					$k -n ${nameSpace} logs -p --tail="${showNumber}" "${param_name}"
					[[ $? -ne 0 ]] && exit 0
					cyan "++++++++++++++++++++++++++ æ˜¾ç¤ºæœ€è¿‘ ${showNumber} æ¡æ•°æ®(previous logs) ++++++++++++++++++++++++++ "
				else
					$k -n ${nameSpace} logs -p "${param_name}"
					[[ $? -ne 0 ]] && exit 0
				fi
			else 
				showNumber=${param07}
				if [ -n "$(echo "${showNumber}"| sed -n "/^[0-9]\+$/p")" ];then # è¡¨ç¤ºæ•°å­—
					$k -n ${nameSpace} logs -p -c "${containerName}" --tail="${showNumber}" "${param_name}"
					[[ $? -ne 0 ]] && exit 0
					cyan "++++++++++++++++++++++++++ æ˜¾ç¤ºæœ€è¿‘ ${showNumber} æ¡æ•°æ®(previous logs) ++++++++++++++++++++++++++ "
				else
					$k -n ${nameSpace} logs -p -c "${containerName}" "${param_name}"
					[[ $? -ne 0 ]] && exit 0
				fi
			fi
			cyan "+++++++++++++++++++ æ­£åœ¨æŸ¥çœ‹å®¹å™¨å…ˆå‰(previous)çš„æ—¥å¿— +++++++++++++++++++"
		else
			showNumber=${param06}
			containerName=${param05}
			if [ -z "${containerName}" ];then 
				if [ -n "$(echo "${showNumber}"| sed -n "/^[0-9]\+$/p")" ];then # è¡¨ç¤ºæ•°å­—
					$k -n ${nameSpace} logs --tail="${showNumber}" "${param_name}"
					cyan "++++++++++++++++++++++++++ æ˜¾ç¤ºæœ€è¿‘ ${showNumber} æ¡æ•°æ® ++++++++++++++++++++++++++ "
				else
					$k -n ${nameSpace} logs "${param_name}"
				fi				
			else 
				if [ -n "$(echo "${showNumber}"| sed -n "/^[0-9]\+$/p")" ];then # è¡¨ç¤ºæ•°å­—
					$k -n ${nameSpace} logs -c "${containerName}" --tail="${showNumber}" "${param_name}"
					cyan "++++++++++++++++++++++++++ æ˜¾ç¤ºæœ€è¿‘ ${showNumber} æ¡æ•°æ® ++++++++++++++++++++++++++ "
				else
					$k -n ${nameSpace} logs -c "${containerName}" "${param_name}"
				fi			
			fi
		fi
	;;
	"Xtail") # è¾“å‡ºæœ€è¿‘çš„æ—¥å¿—				
		showNumber=${param05:=50}
		containerName=${param06}
		# å½“ param05 ä¼ è¿‡æ¥çš„ä¸æ˜¯çº¯æ•°å­—åˆ™è¡¨ç¤ºæ˜¯ containerï¼Œéœ€è¦å¤„ç†ä¸€ä¸‹
		if [ -z "$(echo ${showNumber}| sed -n "/^[0-9]\+$/p")" ];then # è¡¨ç¤ºéæ•°å­—
			containerName="${param05}"
			showNumber=50
		fi
		if [ -z "${containerName}" ];then
			$k -n ${nameSpace} logs --tail=${showNumber} "${param_name}"
			[[ $? -ne 0 ]] && exit 0
		else
			green "æ­£åœ¨æŸ¥çœ‹:ã€${containerName}ã€‘Container Name æ—¥å¿—"
			$k -n ${nameSpace} logs --tail=${showNumber} -c "${containerName}" "${param_name}"
			[[ $? -ne 0 ]] && exit 0
		fi		
		cyan "++++++++++++++++++++++++++ æ˜¾ç¤ºæœ€è¿‘ ${showNumber} æ¡æ•°æ® ++++++++++++++++++++++++++ "
	;;
	"Xtailf") # åŠ¨æ€ç›‘å¬æ—¥å¿—	
		# -c container
		containerName=${param05}
		cyan "+++++++++++++++++ åŠ¨æ€ç›‘å¬æ—¥å¿— +++++++++++++++++"
		if [ -n "${containerName}" ];then 
			green "æ­£åœ¨æŸ¥çœ‹:ã€${containerName}ã€‘Container Name æ—¥å¿—"
			$k -n ${nameSpace} logs -f --tail=15 -c ${containerName} "${param_name}"
			[[ $? -ne 0 ]] && exit 0
		else
			$k -n ${nameSpace} logs -f --tail=15 "${param_name}"
			[[ $? -ne 0 ]] && exit 0
		fi
	;;	
	"Xedit") # ç¼–è¾‘ YAML	
		cyan "+++++++++++++++++ ç¼–è¾‘ ${param_name} YAML +++++++++++++++++"
		$k -n ${nameSpace} edit "${resouce_name}" "${param_name}"
	;;	
	esac
}


# æ¸…ç†åƒåœ¾
clean() {
	if [ -n "${param01}" ]; then
		# local errMsg="UnexpectedAdmissionError"
		for errMsg in "${err_list[@]}"; do
			IsYesNo "æ˜¯å¦æŸ¥æ‰¾ ${errMsg} é”™è¯¯çš„PODï¼Œç¡®è®¤(Y/N):"
			local result=$?
			if [ ${result} -eq 0 ]; then
				count=$($k get pods -n "${param01}" | grep -c "${errMsg}")
				if [ "${count}" -gt 0 ]; then
					IsYesNo "ç©ºé—´ï¼š${param01}ï¼Œé”™è¯¯ï¼š${errMsg}ï¼Œå…±: ${count} æ¡æ•°ï¼Œæ˜¯å¦éœ€è¦æ¸…ç†(Y/N):"
					result=$?
					if [ ${result} -eq 0 ]; then
						green "å¼€å§‹æ¸…ç†..."
						local i=0
						for errPodsName in $($k get pods -n "${param01}" | grep "${errMsg}" | awk '{print $1}'); do
							((i++))
							red "æ­£åœ¨å¤„ç†: ${i}/${count} ${errPodsName}"
							$k delete pods -n "${param01}" "${errPodsName}" --grace-period=0 --force
						done
					fi
				else
					green "ç©ºé—´ï¼š${param01}ï¼Œé”™è¯¯ï¼š${errMsg}ï¼Œå…±: 0 æ¡æ•°"
				fi
			fi
		done
	else
		# local errMsg="UnexpectedAdmissionError"
		for errMsg in "${err_list[@]}"; do
			IsYesNo "æŸ¥æ‰¾æ‰€æœ‰ç©ºé—´ä¸‹çš„ ${errMsg} é”™è¯¯çš„ POD,ç¡®è®¤(Y/N):"
			local result=$?
			if [ ${result} -eq 0 ]; then
				green "æ­£åœ¨ç»Ÿè®¡ä¸åŒç©ºé—´ä¸‹çš„ ${errMsg} æ•°æ®ï¼š"
				$k get pods -A | grep "${errMsg}" | awk '{print $1}' | uniq -c

			fi
		done
		yello "è‹¥æƒ³åˆ é™¤ä»¥ä¸Šç»Ÿè®¡çš„é”™è¯¯,åˆ™ä½¿ç”¨ k1s clean <ç©ºé—´åç§°>"
	fi
}

main() {	
	## èµ„æºåç§°
	in_resource=""
	case "X${resource}" in
	"Xapply" | "Xp")
		apply
		;;
	"Xx" | "Xnsenter") # node-shell
		execTemporaryPod "$2"
		;;
	"Xexec" | "Xauto" | "Xe")
		autoExecPod "$2" "$3"
		;;
	"Xcs" | "Xcomponentstatuses")
		in_resource="componentstatuses"
		;;
	"Xconfigmaps" | "Xcm")
		in_resource="configmaps"
		;;
	"Xendpoints" | "Xep")
		in_resource="endpoints"
		;;
	"Xevents" | "Xev")
		in_resource="events"
		;;
	"Xlimitranges" | "Xlimits" | "Xlimit")
		in_resource="limitranges"
		;;
	"Xnamespaces" | "Xns")
		in_resource="namespaces"
		;;	
	"Xnodes" | "Xnode" | "Xno")
		in_resource="nodes"
		;;
	"Xpersistentvolumeclaims" | "Xpvc")
		in_resource="persistentvolumeclaims"
		;;
	"Xpersistentvolumes" | "Xpv")
		in_resource="persistentvolumes"
		;;
	"Xpods" | "Xpo" | "Xps")
		in_resource="pods"
		;;
	"Xreplicationcontrollers" | "Xrc")
		in_resource="replicationcontrollers"		
		;;
	"Xsecrets" | "Xsecret" | "Xsec")
		in_resource="secrets"		
		;;
	"Xservices" | "Xsvc")
		in_resource="services"		
		;;
	"Xdaemonsets" | "Xds")
		in_resource="daemonsets"		
		;;
	"Xdeployments" | "Xdeploy" | "Xd")
		in_resource="deployments"		
		;;
	"Xreplicasets" | "Xrs")
		in_resource="replicasets"		
		;;
	"Xstatefulsets" | "Xsts")
		in_resource="statefulsets"		
		;;
	"Xhorizontalpodautoscalers" | "Xhpa")
		in_resource="horizontalpodautoscalers"		
		;;
	"Xcronjobs" | "Xcj")
		in_resource="cronjobs"		
		;;
	"Xjobs" | "Xjob")
		in_resource="jobs"		
		;;
	"Xingresses" | "Xing")
		in_resource="ingresses"		
		;;
	"Xingressclasses" | "Xingc")
		in_resource="ingressclasses"
		;;
	"Xclusterrolebindings" | "Xcrb")
		in_resource="clusterrolebindings"
		;;
	"Xserviceaccounts" | "Xsa")
		in_resource="serviceaccounts"		
		;;
	"Xclusterroles" | "Xcr")
		in_resource="clusterroles"
		;;
	"Xrolebindings" | "Xrb")
		in_resource="rolebindings"
		;;
	"Xroles" | "Xro")
		in_resource="roles"		
		;;
	"Xservicemonitor" | "Xsm")
		in_resource="ServiceMonitor"		
		;;		
	"XStorageClass" | "Xsc")
		in_resource="StorageClass"		
		;;		
	"Xall")
		$k -n "${nameSpace}" get all
		;;
	"Xclean" | "Xc")
		clean
		;;
	*)
		help
		;;
	esac
	# æ‹¼æ¥æˆå®Œæ•´çš„å‘½ä»¤
	if [ "${in_resource}" != "" ]; then 
		# èµ„æºåç§° æ˜¯å¦æ˜¯æŸç©ºé—´ä¸‹çš„èµ„æº å‚æ•°01 åŠ¨ä½œåç§° 		
		k1s_resource_action "${in_resource}" ${param01} ${action} ${param02} ${param03} ${param04}
	fi	
}
main "$@"